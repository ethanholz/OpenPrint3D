name: Validate OpenPrint3D Schemas
on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Validate printer schemas
        shell: bash
        run: |
          set -e

          if [ ! -d printer ]; then
            echo "No printer/ directory. Skipping printer validation."
            exit 0
          fi

          mapfile -t files < <(find printer -type f -name '*.json' || true)

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No printer JSON files found. Skipping."
            exit 0
          fi

          echo "Validating printer files:"
          printf '  %s\n' "${files[@]}"

          python tools/validate_schema.py schema/printer.schema.json "${files[@]}"

      - name: Validate filament schemas
        shell: bash
        run: |
          set -e

          if [ ! -d filament ]; then
            echo "No filament/ directory. Skipping filament validation."
            exit 0
          fi

          mapfile -t files < <(find filament -type f -name '*.json' || true)

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No filament JSON files found. Skipping."
            exit 0
          fi

          echo "Validating filament files:"
          printf '  %s\n' "${files[@]}"

          python tools/validate_schema.py schema/filament.schema.json "${files[@]}"

      - name: Validate process schemas
        shell: bash
        run: |
          set -e

          if [ ! -d process ]; then
            echo "No process/ directory. Skipping process validation."
            exit 0
          fi

          mapfile -t files < <(find process -type f -name '*.json' || true)

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No process JSON files found. Skipping."
            exit 0
          fi

          echo "Validating process files:"
          printf '  %s\n' "${files[@]}"

          python tools/validate_schema.py schema/process.schema.json "${files[@]}"
